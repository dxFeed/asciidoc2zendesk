on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

name: Build & Release

env:
  JARFILE: asciidoc2zendesk.jar
  ARTIFACT: asciidoc2zendesk-%VERSION%.tar.gz

jobs:

  check:
    runs-on: ubuntu-latest
    steps:
      - name: check java
        run: |
          java -version

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Set env
        run: |
          echo ::set-env name=RELEASE_VERSION::$(echo ${GITHUB_REF:10})
          echo ::set-env name=ARTIFACT::$(echo ${ARTIFACT} | sed "s/%VERSION%/$(echo ${GITHUB_REF:10})/g" )
#          echo ::set-env name=ARTIFACT::${ARTIFACT}
      - name: Build
        run: |
          ./mvnw clean package
          cd target
          tar cvfz ${{ env.ARTIFACT }} ${JARFILE}
      - uses: actions/upload-artifact@v1
        with:
          name: ${{ env.ARTIFACT }}
          path: target/${{ env.ARTIFACT }}

  publish:
    runs-on: ubuntu-latest
    name: publish release
    needs: [build]
    steps:
      - uses: actions/checkout@master
      - name: Set env
        run: |
          echo ::set-env name=RELEASE_VERSION::$(echo ${GITHUB_REF:10})
          echo ::set-env name=ARTIFACT::$(echo ${ARTIFACT} | sed "s/%VERSION%/$(echo ${GITHUB_REF:10})/g" )
#          echo ::set-env name=ARTIFACT::${ARTIFACT}
      - name: Download artifact
        uses: actions/download-artifact@v1
        with:
          name: ${{ env.ARTIFACT }}
          path: downloads/
      - name: Publish release
        uses: ./.github/actions/publish
        with:
          args: downloads/
          draft_regex: '[0-9]+.[0-9]+.[0-9]+-[a-zA-Z]+'
          prerelease_regex: '[a-zA-Z]+-[0-9]+.[0-9]+.[0-9]+'
#          notes: '${{ steps.notes.outputs.data }}'
        env:
          RELEASE_PREFIX: ${{ env.RELEASE_PREFIX }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
